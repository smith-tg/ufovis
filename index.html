<html>

<head>
	
	<title>UFO Vis</title>
	<link rel="stylesheet" href="./leaflet/leaflet.css"/>
	<script src="./leaflet/leaflet.js"></script>
	<style>
		body {
			background-color: #46515e;
		}
		#map {
			width:960px;
			height: 500px;
			margin:auto;
		}
	</style>
	<link rel="stylesheet" href="./dist/MarkerCluster.css" />
	<link rel="stylesheet" href="./dist/MarkerCluster.Default.css" />
	<script src="./dist/leaflet.markercluster-src.js"></script>
	<script src="./data/cleaned_withSentenTreeFields.js"></script>
</head>

<body>

	<script src="//unpkg.com/candela/dist/candela.min.js"></script>

	<div id="map"></div>

	<form id="shapeSelector" style="width:500px; margin:auto; text-align:center;">
		<label><input type="checkbox" value="all">All</label>
		<label><input type="checkbox" value="circle">Circle</label>
		<label><input type="checkbox" value="light">Light</label>
		<label><input type="checkbox" value="triangle">Triangle</label>
		<label><input type="checkbox" value="cylinder">Cylinder</label>
		<label><input type="checkbox" value="diamond">Diamond</label>
		<label><input type="checkbox" value="disk">Disk</label>
		<label><input type="checkbox" value="fireball">Fireball</label>
		<label><input type="checkbox" value="flash">Formation</label>
		<label><input type="checkbox" value="oval">Oval</label>
		<label><input type="checkbox" value="rectangle">Rectangle</label>
		<label><input type="checkbox" value="egg">Egg</label>
		<label><input type="checkbox" value="cigar">Cigar</label>
		<label><input type="checkbox" value="teardrop">Teardrop</label>
		<label><input type="checkbox" value="sphere">Sphere</label>
		<label><input type="checkbox" value="chevron">Chevron</label>
		<label><input type="checkbox" value="changing">Changing</label>
		<label><input type="checkbox" value="other">Other</label>
		<label><input type="checkbox" value="unspecified">Unspecified</label>
	</form>

	<form id="keywordSearch" style="margin:auto; text-align:center;">
		<label>Keywords (comma-separated):  <input id="keywords" type="text" style="width:500px;"></label>
	</form>

	<h3>Filter by Date</h3>
	<form id="dateSelector">
		Years (YYYY)
		<br />
		<label>From:  <input id="fromYear"></label>
		<label>To:  <input id="toYear"></label>
		<br />
		Months (MM)
		<br />
		<label>From:  <input id="fromMonth"></label>
		<label>To:  <input id="toMonth"></label>
		<br />
		Days (DD)
		<br />
		<label>From:  <input id="fromDay"></label>
		<label>To:  <input id="toDay"></label>
	</form>

	<h3>Filter by Time</h3>
	<form id="timeSelector">
		<label>From:  <input id="fromTime"></label>
		<label>To:  <input id="toTime"></label>
	</form>

	<h3>Filter by Duration (seconds)</h3>
	<form id="durationSelector">
		<label>Minimum duration:  <input id="minDuration"></label>
		<label>Maximum duration:  <input id="maxDuration"></label>
	</form>

	<button onclick="updateFilters();">Apply Filters</button>

	<button style="display:block;" onclick="loadSentenTree();">Load SentenTree</button>
	<button style="display:block;" onclick="cloneSentenTree();">Clone Current SentenTree</button>

	<script type="text/javascript">

		// grab shape filter boxes
		var shapeForm = document.getElementById('shapeSelector');
		var selectedShapes = shapeForm.getElementsByTagName('input');
		
		// generate map frame
		var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Points &copy 2012 LINZ'
		}),
			latlng = L.latLng([39.8283,-98.5795]);

		var map = L.map('map', {center: latlng, zoom: 3, layers: [tiles]});	
		
		// initialize map boundary variables
		var northBound = map.getBounds().getNorth();
		var eastBound = map.getBounds().getEast();
		var southBound = map.getBounds().getSouth();
		var westBound = map.getBounds().getWest();

		// initialize date ranges
		var dateRanges = [0,3000,1,12,1,31];
		
		// initialize report variables
		var allReports = reportLocation;
		var displayedReports = [];
		var inFrame = [];

		// create marker group
		var markers = L.markerClusterGroup();

		var sentenTreeCloneCount = 0;

		function submitHandler(event) {
			event.preventDefault();
			updateFilters();
		}
		
		// filter visible results for sententree
		function updateBounds() {
			northBound = map.getBounds().getNorth();
			eastBound = map.getBounds().getEast();
			southBound = map.getBounds().getSouth();
			westBound = map.getBounds().getWest();
		}

		function filterOnBounds() {
			updateBounds();

			inFrame = [];

			for (var i=0; i < displayedReports.length; i++) {
				var line = displayedReports[i];
				
				if ((line[5]<=northBound)&&(line[5]>=southBound)&&(line[6]<=eastBound)&&(line[6]>=westBound)) {
					inFrame.push(line);
				}
			}

		}

		// attach filtered results to map
		function showReports() {
			markers.clearLayers();

			for (var i=0; i<displayedReports.length; i++) {
				var a = displayedReports[i];
				var detailView = a[7]
				var marker = L.marker(new L.LatLng(a[5], a[6]), { title: detailView });

				marker.bindPopup(detailView);
				markers.addLayer(marker);
			}

			map.addLayer(markers);
		
		}


		// update filter conditions and apply
		function updateFilters() {
			var shapes = shapeFilter();
			var keywords = keywordFilter();
			var selectedDates = dateFilter();
			var durations = durationFilter();
			applyFilters(keywords,shapes,selectedDates,durations);
			showReports();
		}


		function applyFilters(keywordSet,shapeSet,dateSet,durationSet) {
			filteredResults = [];
			
			for (var i=0; i<allReports.length; i++) {
				
				var row = allReports[i];
				var commentString = row[7].toLowerCase();

				var year = parseInt(row[1]);
				var month = parseInt(row[2]);
				var day = parseInt(row[3]);

				var reportDuration = parseInt(row[8]);
				
				// apply keyword filter
				var keywordPassed = false;

				if (!keywordSet.length) {
					keywordPassed = true;
				}
				else {
					for (var k=0; k<keywordSet.length; k++) {
						if (commentString.search(keywordSet[k])!==-1) {
							keywordPassed = true;
							break;
						}
					}
				}
				
				if (!keywordPassed) {
						continue;
				}

				// apply shape filter
				var shapePassed = false;
					
				for (var s=0; s<shapeSet.length; s++) {
					if (row[4] == shapeSet[s]) {
						shapePassed = true;
						break;
					}
				}
				if (!shapePassed) {
					continue;
				}
				
				// apply time filter
				if (!(((year>=dateSet[0])&&(year<=dateSet[1])) && ((month>=dateSet[2])&&(month<=dateSet[3])) && ((day>=dateSet[4])&&(day<=dateSet[5])))) {
					continue;
				}

				if (!((reportDuration>=durationSet[0])&&(reportDuration<=durationSet[1]))) {
					continue;
				}

				filteredResults.push(row);

			}
			
			displayedReports = filteredResults;
			
		}

		// toggle shape selector checkboxes
		function toggleAll() {
			if (this.value == 'all' && this.checked) {
				for (i=1; i < selectedShapes.length; i++) {
					selectedShapes[i].checked = true;
				}
			}
			else if (this.value == 'all' && !(this.checked)) {
				for (i=1; i < selectedShapes.length; i++) {
					selectedShapes[i].checked = false;
				}	
			}
			else if (this.value != 'all') {
				selectedShapes[0].checked = false;
			}
		}

		// filters
		function keywordFilter() {
			var contents = document.getElementById('keywords').value.toLowerCase();

			if (contents != '') {
				var kwArray = contents.split(',');
			}
			else {
				kwArray = [];
			}

			return kwArray;
		}

		function shapeFilter() {		

			var displayShapes = [];

			for (var i=1; i<selectedShapes.length; i++) {
				if (selectedShapes[i].checked) {
					displayShapes.push(selectedShapes[i].value);
				}
			}

			return displayShapes;
			
		}

		function dateFilter() {
			var fromYear = document.getElementById('fromYear').value;
			var toYear = document.getElementById('toYear').value;
			var fromMonth = document.getElementById('fromMonth').value;
			var toMonth = document.getElementById('toMonth').value;
			var fromDay = document.getElementById('fromDay').value;
			var toDay = document.getElementById('toDay').value;

			var dateStrings = [fromYear,toYear,fromMonth,toMonth,fromDay,toDay];
			var dateFields = [];

			for (i=0;i<dateStrings.length;i++) {
				if (!dateStrings[i]) {
					dateFields.push(dateRanges[i]);
				}
				else {
					dateFields.push(parseInt(dateStrings[i]));
				}
			}

			return dateFields
		}

		function durationFilter() {
			var minDuration = document.getElementById('minDuration').value;
			var maxDuration = document.getElementById('maxDuration').value;

			var durationRange = [];

			if (minDuration) {
				durationRange.push(parseInt(minDuration));
			}
			else {
				durationRange.push(0);
			}
			if (maxDuration) {
				durationRange.push(parseInt(maxDuration));
			}
			else {
				durationRange.push(1000000000000);
			}

			return durationRange;
		}

		// generate sententree output frame
		function loadSentenTree() {
			
			filterOnBounds();

			if (document.contains(document.getElementById('sentenTree'))) {
				document.getElementById('sentenTree').remove();
			}

			var el = document.createElement('sentenTree');
			el.id = 'sentenTree';
			el.style.display = 'block';
			el.style.width = '1200px';
			el.style.margin = 'auto';

			document.body.appendChild(el);

			var sentenTreeData = [];

			for (i=0; i < inFrame.length; i++) {
				var b = inFrame[i];
				sentenTreeData.push(b[0]);
			}

			var vis = new candela.components.SentenTree(el, { 
				data: sentenTreeData,
				graphs: 1
				});

			vis.render();
		
		}
		
		// copy current sententree output to separate field
		function cloneSentenTree() {
			var originalSentenTree = document.getElementById('sentenTree');
			var sentenTreeClone = originalSentenTree.cloneNode(true);
			sentenTreeClone.id = 'sentenTreeClone' + ++sentenTreeCloneCount;
			document.body.appendChild(sentenTreeClone);
		}


		function attachHandlers() {
			for (var i=0; i < selectedShapes.length; i++) {
				selectedShapes[i].onclick = toggleAll;
			}

			var keywordSubmitForm = document.getElementById('keywordSearch');
			var dateSubmitForm = document.getElementById('dateSelector');
			var timeSubmitForm = document.getElementById('timeSelector');
			var durationSubmitForm = document.getElementById('durationSelector');

			var submitForms = [keywordSubmitForm,dateSubmitForm,timeSubmitForm,durationSubmitForm];

			for (f=0;f<submitForms.length;f++) {
				submitForms[f].addEventListener('submit',submitHandler);
			}
		}

		attachHandlers();
	
	</script>

</body>

</html>