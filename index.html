<html>

<head>
	
	<title>UFO Vis</title>
	<link rel="stylesheet" href="./leaflet/leaflet.css"/>
	<script src="./leaflet/leaflet.js"></script>
	<style>
		body {
			background-color: #46515e;
		}
		#map {
			width:960px;
			height: 500px;
			margin:auto;
		}
	</style>
	<link rel="stylesheet" href="./dist/MarkerCluster.css" />
	<link rel="stylesheet" href="./dist/MarkerCluster.Default.css" />
	<script src="./dist/leaflet.markercluster-src.js"></script>
	<script src="./data/cleaned_withSentenTreeFields.js"></script>
</head>

<body>

	<script src="//unpkg.com/candela/dist/candela.min.js"></script>

	<div id="map"></div>

	<form id="shapeSelector" style="width:500px; margin:auto; text-align:center;">
		<label><input type="checkbox" value="all">All</label>
		<label><input type="checkbox" value="circle">Circle</label>
		<label><input type="checkbox" value="light">Light</label>
		<label><input type="checkbox" value="triangle">Triangle</label>
		<label><input type="checkbox" value="cylinder">Cylinder</label>
		<label><input type="checkbox" value="diamond">Diamond</label>
		<label><input type="checkbox" value="disk">Disk</label>
		<label><input type="checkbox" value="fireball">Fireball</label>
		<label><input type="checkbox" value="flash">Formation</label>
		<label><input type="checkbox" value="oval">Oval</label>
		<label><input type="checkbox" value="rectangle">Rectangle</label>
		<label><input type="checkbox" value="egg">Egg</label>
		<label><input type="checkbox" value="cigar">Cigar</label>
		<label><input type="checkbox" value="teardrop">Teardrop</label>
		<label><input type="checkbox" value="sphere">Sphere</label>
		<label><input type="checkbox" value="chevron">Chevron</label>
		<label><input type="checkbox" value="changing">Changing</label>
		<label><input type="checkbox" value="other">Other</label>
		<label><input type="checkbox" value="unspecified">Unspecified</label>
	</form>

	<button onclick="updateFilters();">Apply Filters</button>

	<button style="display:block;" onclick="loadSentenTree();">Load SentenTree</button>
	<button style="display:block;" onclick="cloneSentenTree();">Clone Current SentenTree</button>

	<script type="text/javascript">

		// grab shape filter boxes
		var shapeForm = document.getElementById('shapeSelector');
		var selectedShapes = shapeForm.getElementsByTagName('input');
		
		// generate map frame
		var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Points &copy 2012 LINZ'
		}),
			latlng = L.latLng([39.8283,-98.5795]);

		var map = L.map('map', {center: latlng, zoom: 3, layers: [tiles]});	
		
		// initialize map boundary variables
		var northBound = map.getBounds().getNorth();
		var eastBound = map.getBounds().getEast();
		var southBound = map.getBounds().getSouth();
		var westBound = map.getBounds().getWest();	

		// initialize report variables
		var allReports = reportLocation;
		var displayedReports = [];
		var inFrame = [];

		// create marker group
		var markers = L.markerClusterGroup();



		var sentenTreeCloneCount = 0;
		
		function updateBounds() {
			northBound = map.getBounds().getNorth();
			eastBound = map.getBounds().getEast();
			southBound = map.getBounds().getSouth();
			westBound = map.getBounds().getWest();
		}

		function filterOnBounds() {
			updateBounds();

			inFrame = [];

			for (var i=0; i < displayedReports.length; i++) {
				var line = displayedReports[i];
				
				if ((line[3]<=northBound)&&(line[3]>=southBound)&&(line[4]<=eastBound)&&(line[4]>=westBound)) {
					inFrame.push(line);
				}
			}

		}

		function showReports() {
			markers.clearLayers();

			for (var i=0; i<displayedReports.length; i++) {
				var a = displayedReports[i];
				var detailView = a[5]
				var marker = L.marker(new L.LatLng(a[3], a[4]), { title: detailView });

				marker.bindPopup(detailView);
				markers.addLayer(marker);
			}

			map.addLayer(markers);
		
		}
		
		function updateFilters() {
			var shapes = shapeFilter();
			applyFilters(shapes);
			showReports();
		}


		function applyFilters(shapeSet) {
			filteredResults = [];
			
			for (var i = 0; i < allReports.length; i++) {
				var row = allReports[i];
				for (var j=0; j < shapeSet.length; j++) {
					if (row[2] == shapeSet[j]) {
						filteredResults.push(row);
						break;
					}
				}
			}
			
			displayedReports = filteredResults;
			showReports();
			
		}

		function toggleAll() {
			if (this.value == 'all' && this.checked) {
				for (i=1; i < selectedShapes.length; i++) {
					selectedShapes[i].checked = true;
				}
			}
			else if (this.value == 'all' && !(this.checked)) {
				for (i=1; i < selectedShapes.length; i++) {
					selectedShapes[i].checked = false;
				}	
			}
			else if (this.value != 'all') {
				selectedShapes[0].checked = false;
			}
		}
		

		function shapeFilter() {		

			var displayShapes = [];

			for (var i=1; i<selectedShapes.length; i++) {
				if (selectedShapes[i].checked) {
					displayShapes.push(selectedShapes[i].value);
				}
			}

			return displayShapes;
			
		}

		function loadSentenTree() {
			
			filterOnBounds();

			if (document.contains(document.getElementById('sentenTree'))) {
				document.getElementById('sentenTree').remove();
			}

			var el = document.createElement('sentenTree');
			el.id = 'sentenTree';
			el.style.display = 'block';
			el.style.width = '1200px';
			el.style.margin = 'auto';

			document.body.appendChild(el);

			var sentenTreeData = [];

			for (i=0; i < inFrame.length; i++) {
				var b = inFrame[i];
				sentenTreeData.push(b[0]);
			}

			var vis = new candela.components.SentenTree(el, { 
				data: sentenTreeData,
				graphs: 1
				});

			vis.render();
		
		}
		
		function cloneSentenTree() {
			var originalSentenTree = document.getElementById('sentenTree');
			var sentenTreeClone = originalSentenTree.cloneNode(true);
			sentenTreeClone.id = 'sentenTreeClone' + ++sentenTreeCloneCount;
			document.body.appendChild(sentenTreeClone);
		}


		function attachHandlers() {
			for (var i=0; i < selectedShapes.length; i++) {
				selectedShapes[i].onclick = toggleAll;
			}

		}

		attachHandlers();
	
	</script>

</body>

</html>